# ЭТАП 1: АЛГОРИТМИЧЕСКАЯ СИСТЕМА АНАЛИЗА АВАРИЙНЫХ СИГНАЛОВ

**Версия:** 1.0  
**Дата:** 2025  
**Статус:** Проектирование

---

## Оглавление

1. [Обзор этапа](#обзор-этапа)
2. [Архитектура системы](#архитектура-системы)
3. [Компоненты системы](#компоненты-системы)
4. [Алгоритмы анализа](#алгоритмы-анализа)
5. [Интерфейсы системы](#интерфейсы-системы)
6. [Интеграции с внешними системами](#интеграции-с-внешними-системами)
7. [Технический стек](#технический-стек)
8. [Процессы работы](#процессы-работы)
9. [Модель данных](#модель-данных)

---

## Обзор этапа

### Цель этапа

Создание алгоритмической системы автоматизации анализа аварийных сигналов без использования машинного обучения. Система должна:

- Автоматически анализировать тренды параметров оборудования
- Проверять соответствие уставок фактическим рабочим параметрам
- Выявлять ложные тревоги и несоответствия
- Генерировать рекомендации по устранению проблем
- Предоставлять интерфейсы для различных ролей пользователей

### Ключевые возможности

1. **Автоматический анализ трендов** - анализ исторических данных за 2 месяца
2. **Проверка уставок** - сравнение фактических параметров с уставками и нормативами
3. **Выявление ложных сигналов** - определение сигналов от неработающего оборудования
4. **Генерация рекомендаций** - автоматическое формирование рекомендаций по устранению проблем
5. **Мониторинг и отчетность** - дашборды и отчеты для различных уровней управления

### Ограничения этапа

- Не используется машинное обучение
- Алгоритмы основаны на детерминированных правилах
- Анализ основан на статистических методах и сравнениях
- Рекомендации формируются по предопределенным шаблонам

---

## Архитектура системы

### Общая архитектура

```
┌─────────────────────────────────────────────────────────────────┐
│                        Внешние системы                          │
├──────────────┬──────────────┬──────────────┬────────────────────┤
│   АСДКУ      │   Мега       │   Проток     │   КИС «Армитс»     │
│   ЕССД       │   1С ТОиР     │   СЭД        │                     │
└──────┬───────┴──────┬───────┴──────┬───────┴──────────┬──────────┘
       │              │              │                   │
       └──────────────┴──────────────┴───────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────────────┐
│                    Слой интеграции                              │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────────────┐  │
│  │   API Gateway│  │  Data Sync   │  │   File Parser         │  │
│  │              │  │  Service     │  │   (PDF, Excel)       │  │
│  └──────────────┘  └──────────────┘  └──────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────────────┐
│                    Бизнес-логика                                │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────────────┐  │
│  │ Trend        │  │  Threshold   │  │  Recommendation      │  │
│  │ Analyzer     │  │  Validator   │  │  Generator           │  │
│  └──────────────┘  └──────────────┘  └──────────────────────┘  │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────────────┐  │
│  │ Equipment    │  │  Alarm       │  │  Notification        │  │
│  │ Status       │  │  Classifier   │  │  Service             │  │
│  │ Checker      │  │              │  │                      │  │
│  └──────────────┘  └──────────────┘  └──────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────────────┐
│                    Слой данных                                   │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────────────┐  │
│  │  Time Series │  │  Metadata    │  │  Recommendations     │  │
│  │  Database    │  │  Database    │  │  Database            │  │
│  └──────────────┘  └──────────────┘  └──────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────────────┐
│                    Интерфейсы                                   │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────────────┐  │
│  │  Web UI      │  │  Mobile App  │  │  API REST           │  │
│  │  (React)     │  │  (React      │  │                     │  │
│  │              │  │   Native)    │  │                     │  │
│  └──────────────┘  └──────────────┘  └──────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
```

### Компонентная архитектура

#### 1. Слой интеграции (Integration Layer)

**Назначение:** Получение данных из внешних систем

**Компоненты:**
- **API Gateway** - единая точка входа для внешних API
- **Data Sync Service** - синхронизация данных из АСДКУ, Мега, Проток
- **File Parser Service** - парсинг PDF документов из СЭД, РД
- **Data Normalizer** - нормализация данных из разных источников

#### 2. Слой бизнес-логики (Business Logic Layer)

**Назначение:** Обработка данных и генерация рекомендаций

**Компоненты:**
- **Trend Analyzer** - анализ трендов параметров
- **Threshold Validator** - проверка соответствия уставок
- **Equipment Status Checker** - проверка состояния оборудования
- **Alarm Classifier** - классификация типов тревог
- **Recommendation Generator** - генерация рекомендаций
- **Notification Service** - отправка уведомлений

#### 3. Слой данных (Data Layer)

**Назначение:** Хранение данных

**Компоненты:**
- **Time Series Database** - хранение временных рядов параметров
- **Metadata Database** - хранение метаданных объектов, оборудования, уставок
- **Recommendations Database** - хранение рекомендаций и их статусов
- **Cache Layer** - кэширование часто запрашиваемых данных

#### 4. Слой интерфейсов (Presentation Layer)

**Назначение:** Предоставление интерфейсов пользователям

**Компоненты:**
- **Web Application** - веб-интерфейс для десктопов
- **Mobile Application** - мобильное приложение
- **REST API** - API для интеграций
- **Report Generator** - генерация отчетов

---

## Компоненты системы

### 1. Trend Analyzer (Анализатор трендов)

**Назначение:** Анализ исторических данных параметров оборудования

**Входные данные:**
- Временные ряды параметров (давление, уровень, температура)
- Период анализа: текущий месяц и предыдущий месяц
- Метаданные объекта и оборудования

**Алгоритм:**
1. Загрузка данных за текущий период (месяц)
2. Загрузка данных за предыдущий период (месяц)
3. Расчет статистических показателей:
   - Среднее значение
   - Минимальное значение
   - Максимальное значение
   - Медиана
   - Стандартное отклонение
4. Сравнение периодов:
   - Процентное изменение среднего значения
   - Изменение диапазона значений
   - Выявление трендов (рост/падение)
5. Определение аномалий:
   - Значения за пределами 3 сигм
   - Резкие скачки значений
   - Длительные периоды стабильности (возможный вывод из эксплуатации)

**Выходные данные:**
- Статистика по параметрам
- Сравнительный анализ периодов
- Список аномалий
- Визуализация трендов

### 2. Threshold Validator (Валидатор уставок)

**Назначение:** Проверка соответствия уставок фактическим параметрам и нормативам

**Входные данные:**
- Фактические рабочие параметры (из Trend Analyzer)
- Текущие уставки сигнализации (из СЭД)
- Нормативные требования (из РД)
- Паспортные данные оборудования (из 1С ТОиР, КИС «Армитс»)

**Алгоритм:**
1. Получение фактических рабочих параметров:
   - Среднее рабочее давление/уровень
   - Диапазон рабочих значений
   - Максимальные и минимальные значения
2. Получение текущих уставок:
   - Минимальная уставка сигнализации
   - Максимальная уставка сигнализации
   - Аварийные уставки
3. Получение нормативных требований:
   - Допустимые параметры работы оборудования
   - Требования ФНиП
4. Получение паспортных данных:
   - Максимальное/минимальное давление для оборудования
   - Рекомендуемые рабочие параметры
5. Проверка соответствий:
   - Уставка < Фактическое рабочее значение → Рекомендация увеличить уставку
   - Уставка > Допустимое максимальное → Рекомендация уменьшить уставку
   - Фактическое значение > Допустимое максимальное → Рекомендация заменить оборудование
   - Фактическое значение < Допустимое минимальное → Рекомендация проверить оборудование
6. Расчет рекомендуемых уставок:
   - На основе фактических параметров + запас (10-15%)
   - С учетом нормативных требований
   - С учетом паспортных данных

**Выходные данные:**
- Список несоответствий уставок
- Рекомендуемые значения уставок
- Обоснование рекомендаций
- Приоритеты исправлений

### 3. Equipment Status Checker (Проверка состояния оборудования)

**Назначение:** Определение фактического состояния оборудования

**Входные данные:**
- Текущие значения параметров
- Состояние насосов (работает/остановлен)
- Уровни в емкостях
- История изменений параметров

**Алгоритм:**
1. Проверка наличия данных:
   - Если данные отсутствуют длительное время → Возможен обрыв связи
   - Если значения стабильны на нуле → Возможен вывод из эксплуатации
2. Проверка состояния насосов:
   - Насос работает → Проверка параметров при работе
   - Насос остановлен → Исключение сигналов давления на выкиде
3. Проверка уровней в емкостях:
   - Уровень < 0 → Емкость не в эксплуатации
   - Уровень стабилен на минимальном → Возможен вывод из эксплуатации
4. Проверка корреляции параметров:
   - Давление в емкости ≈ Давление на приеме насоса → Нормальная работа
   - Давление на выкиде падает при остановке насоса → Нормальное поведение
5. Определение ложных сигналов:
   - Сигналы от неработающего оборудования
   - Сигналы при нормальном технологическом процессе

**Выходные данные:**
- Статус оборудования (в работе/остановлено/выведено из эксплуатации)
- Список ложных сигналов
- Рекомендации по отключению сигналов

### 4. Alarm Classifier (Классификатор тревог)

**Назначение:** Классификация типов аварийных сигналов

**Входные данные:**
- Список аварийных сигналов из ЕССД/АСДКУ
- Метаданные сигналов (объект, параметр, время)
- Результаты анализа трендов и состояния оборудования

**Алгоритм:**
1. Группировка сигналов:
   - По объекту (ДНС, ГЗНУ, скважина)
   - По типу параметра (давление, уровень, загазованность)
   - По типу сигнала (высокое/низкое, аварийное/предупредительное)
2. Определение причин сработок:
   - Несоответствие уставок → Используется Threshold Validator
   - Ложный сигнал → Используется Equipment Status Checker
   - Изменение режима работы → Используется Trend Analyzer
   - Плановые работы → Проверка календаря работ
3. Приоритизация:
   - Количество сработок
   - Критичность параметра
   - Влияние на производство
4. Формирование групп для анализа:
   - Топ объектов с наибольшим количеством сигналов
   - Повторяющиеся сигналы
   - Новые типы сигналов

**Выходные данные:**
- Классифицированные сигналы
- Определенные причины сработок
- Приоритеты обработки
- Группы для анализа

### 5. Recommendation Generator (Генератор рекомендаций)

**Назначение:** Формирование рекомендаций по устранению проблем

**Входные данные:**
- Результаты анализа трендов
- Результаты проверки уставок
- Результаты проверки состояния оборудования
- Классифицированные сигналы

**Алгоритм:**
1. Анализ всех результатов компонентов
2. Формирование рекомендаций по шаблонам:

   **Тип 1: Изменение уставок**
   - Шаблон: "Рекомендуется [увеличить/уменьшить] уставку [параметр] с [текущее значение] до [рекомендуемое значение]"
   - Обоснование: Фактическое рабочее значение [X], текущая уставка [Y]
   - Адресат: Руководство ЦДНГ
   - Приоритет: Высокий/Средний/Низкий

   **Тип 2: Замена оборудования**
   - Шаблон: "Рекомендуется произвести замену [оборудование] на [модель]. Текущие параметры [X] выходят за допустимые [Y]"
   - Обоснование: Фактическое давление [X] МПа, допустимое [Y] МПа
   - Адресат: Специалист отдела, руководство ЦДНГ
   - Приоритет: Высокий

   **Тип 3: Отключение сигналов**
   - Шаблон: "Рекомендуется отключить сигналы [параметр] для [оборудование]. Оборудование выведено из эксплуатации"
   - Обоснование: Емкость не в эксплуатации, уровень [X] м, давление отсутствует
   - Адресат: ООО «ПЦ»
   - Приоритет: Средний

   **Тип 4: Исключение сигнализации при определенных условиях**
   - Шаблон: "Рекомендуется исключить сигнализацию [параметр] при [условие]"
   - Обоснование: Сигнализация срабатывает при остановке насоса, что является нормальным процессом
   - Адресат: ООО «ПЦ»
   - Приоритет: Средний

   **Тип 5: Проведение ЭПБ**
   - Шаблон: "Рекомендуется провести ЭПБ [оборудование]. Срок эксплуатации истек в [год]"
   - Обоснование: Срок эксплуатации истек
   - Адресат: ЦАСУТП
   - Приоритет: Высокий

   **Тип 6: Разработка мероприятий**
   - Шаблон: "Разработать мероприятия по [действие] для [оборудование]"
   - Обоснование: [Детальное описание проблемы]
   - Адресат: Руководство ЦДНГ, мастера
   - Приоритет: Высокий

3. Группировка рекомендаций:
   - По объекту
   - По типу рекомендации
   - По приоритету
4. Проверка дубликатов:
   - Объединение похожих рекомендаций
   - Обновление существующих рекомендаций
5. Формирование уведомлений:
   - Email уведомления адресатам
   - Уведомления в системе
   - SMS для критичных рекомендаций

**Выходные данные:**
- Список рекомендаций с обоснованием
- Уведомления адресатам
- История рекомендаций

### 6. Notification Service (Сервис уведомлений)

**Назначение:** Отправка уведомлений и рекомендаций

**Функции:**
- Email уведомления
- Уведомления в веб-интерфейсе
- SMS уведомления (для критичных)
- Интеграция с корпоративными системами уведомлений

**Настройки:**
- Расписание отправки (ежедневно, еженедельно)
- Фильтры по приоритету
- Группировка уведомлений
- Персонализация по ролям

---

## Алгоритмы анализа

### Алгоритм 1: Анализ давления в емкости

**Входные данные:**
- Идентификатор емкости
- Период анализа (текущий месяц, предыдущий месяц)

**Шаги:**
1. Загрузка данных давления за текущий месяц
2. Загрузка данных давления за предыдущий месяц
3. Загрузка данных уровня в емкости
4. Расчет статистики:
   - Среднее давление
   - Диапазон значений
   - Сравнение с предыдущим периодом
5. Проверка состояния:
   - Если уровень < 0 → Емкость не в эксплуатации
   - Если давление стабильно на нуле → Возможен вывод из эксплуатации
6. Проверка уставок:
   - Сравнение фактического давления с уставками
   - Проверка соответствия нормативным требованиям
7. Формирование рекомендаций

**Выходные данные:**
- Статистика давления
- Статус емкости
- Рекомендации

### Алгоритм 2: Анализ давления на приеме насоса

**Входные данные:**
- Идентификатор насоса
- Период анализа

**Шаги:**
1. Загрузка данных давления на приеме
2. Загрузка данных состояния насоса (работает/остановлен)
3. Загрузка данных давления в емкости
4. Загрузка данных объемов перекачки
5. Расчет статистики:
   - Среднее давление при работе насоса
   - Диапазон значений
   - Сравнение с предыдущим периодом
6. Анализ корреляции:
   - Давление на приеме vs Давление в емкости
   - Давление vs Объемы перекачки
7. Проверка уставок:
   - Сравнение с текущими уставками
   - Проверка допустимых параметров насоса
8. Анализ прогноза:
   - Прогноз объемов перекачки на следующий месяц
   - Оценка влияния на давление
9. Формирование рекомендаций

**Выходные данные:**
- Статистика давления
- Анализ корреляций
- Прогноз
- Рекомендации

### Алгоритм 3: Анализ давления на выкиде насоса

**Входные данные:**
- Идентификатор насоса
- Период анализа

**Шаги:**
1. Загрузка данных давления на выкиде
2. Загрузка данных состояния насоса
3. Расчет статистики:
   - Среднее давление при работе
   - Давление при остановке
   - Диапазон значений
4. Проверка условий сработки:
   - Если сигнал срабатывает при остановленном насосе → Ложный сигнал
   - Если давление ниже допустимого при работе → Проблема с насосом
5. Проверка уставок:
   - Сравнение с текущими уставками
   - Проверка допустимых параметров
6. Формирование рекомендаций:
   - Исключить сигнализацию при остановленном насосе
   - Или заменить насос, если параметры не соответствуют

**Выходные данные:**
- Статистика давления
- Анализ условий сработки
- Рекомендации

### Алгоритм 4: Выявление ложных сигналов

**Входные данные:**
- Список аварийных сигналов
- Данные о состоянии оборудования
- Исторические данные параметров

**Шаги:**
1. Для каждого сигнала:
   - Определение объекта и параметра
   - Проверка состояния оборудования
   - Анализ исторических данных
2. Проверка условий ложного сигнала:
   - Оборудование выведено из эксплуатации
   - Оборудование остановлено (для определенных типов сигналов)
   - Отсутствие данных длительное время
   - Стабильные нулевые значения
3. Группировка ложных сигналов:
   - По объекту
   - По типу причины
4. Формирование рекомендаций:
   - Отключить сигналы для неработающего оборудования
   - Исключить сигнализацию при определенных условиях

**Выходные данные:**
- Список ложных сигналов
- Рекомендации по отключению

### Алгоритм 5: Ежедневный анализ и формирование отчетов

**Входные данные:**
- Список аварийных сигналов за день
- Данные по всем объектам

**Шаги:**
1. Загрузка списка сигналов из ЕССД/АСДКУ
2. Группировка по НГДУ
3. Для каждого НГДУ:
   - Определение топ объектов с наибольшим количеством сигналов
   - Анализ каждого объекта (используя алгоритмы 1-4)
   - Формирование рекомендаций
4. Формирование сводного отчета:
   - Общая статистика по НГДУ
   - Топ проблемных объектов
   - Список рекомендаций
5. Отправка отчетов:
   - Руководству ЦДНГ
   - Мастерам
   - Специалистам отделов

**Выходные данные:**
- Сводный отчет
- Детальные отчеты по объектам
- Список рекомендаций

---

## Интерфейсы системы

### 1. Веб-интерфейс (Web Application)

#### 1.1. Дашборд для диспетчера ЕДС

**Назначение:** Мониторинг текущей ситуации с аварийными сигналами

**Компоненты:**
- **Панель текущих тревог:**
  - Список активных тревог в реальном времени
  - Фильтры: по НГДУ, по типу объекта, по приоритету
  - Сортировка: по времени, по количеству сработок
  - Цветовая индикация: критичные (красный), предупреждения (желтый), информационные (синий)
- **Статистика за период:**
  - График количества тревог по дням
  - Распределение по типам объектов
  - Распределение по НГДУ
  - Сравнение с предыдущим периодом
- **Топ проблемных объектов:**
  - Таблица объектов с наибольшим количеством сигналов
  - Возможность перехода к детальному анализу
- **Быстрые действия:**
  - Кнопка запуска анализа
  - Кнопка формирования отчета
  - Кнопка отправки уведомлений

**Технологии:** React, TypeScript, Material-UI или Ant Design, Chart.js или Recharts

#### 1.2. Интерфейс анализа объекта

**Назначение:** Детальный анализ конкретного объекта

**Компоненты:**
- **Информация об объекте:**
  - Наименование, НГДУ, тип объекта
  - Список оборудования
  - Текущие уставки
- **Графики параметров:**
  - График давления/уровня за период
  - Сравнение с предыдущим периодом
  - Визуализация уставок на графике
  - Отметки моментов сработок сигналов
- **Статистика:**
  - Средние значения
  - Диапазоны значений
  - Количество сработок
- **Анализ:**
  - Результаты анализа трендов
  - Результаты проверки уставок
  - Выявленные проблемы
- **Рекомендации:**
  - Список рекомендаций с обоснованием
  - Возможность принять/отклонить рекомендацию
  - История рекомендаций
- **Действия:**
  - Кнопка запуска анализа
  - Кнопка экспорта отчета
  - Кнопка создания заявки в ООО «ПЦ»

**Технологии:** React, TypeScript, Material-UI, Chart.js, React Query

#### 1.3. Интерфейс управления уставками

**Назначение:** Просмотр и управление уставками сигнализаций

**Компоненты:**
- **Список объектов:**
  - Дерево объектов по НГДУ
  - Фильтры и поиск
- **Таблица уставок:**
  - Объект, параметр, текущая уставка, рекомендуемая уставка
  - Статус (соответствует/не соответствует)
  - Кнопка просмотра обоснования
- **Детальный просмотр:**
  - Текущие уставки
  - Фактические параметры
  - Рекомендуемые уставки с обоснованием
  - История изменений уставок
  - Кнопка применения рекомендации
- **Массовые операции:**
  - Выбор нескольких объектов
  - Массовое применение рекомендаций
  - Экспорт списка для ООО «ПЦ»

**Технологии:** React, TypeScript, Material-UI, React Table

#### 1.4. Интерфейс рекомендаций

**Назначение:** Управление рекомендациями системы

**Компоненты:**
- **Список рекомендаций:**
  - Фильтры: по типу, по приоритету, по статусу, по адресату
  - Сортировка: по дате, по приоритету
  - Группировка: по объекту, по типу
- **Карточка рекомендации:**
  - Описание проблемы
  - Обоснование рекомендации
  - Предлагаемые действия
  - Адресат
  - Приоритет
  - Статус (новая/в работе/выполнена/отклонена)
- **Действия:**
  - Принять рекомендацию
  - Отклонить с комментарием
  - Назначить исполнителя
  - Изменить приоритет
  - Добавить комментарий
- **История:**
  - История изменений статуса
  - Комментарии
  - Прикрепленные файлы

**Технологии:** React, TypeScript, Material-UI

#### 1.5. Интерфейс отчетов

**Назначение:** Просмотр и формирование отчетов

**Компоненты:**
- **Шаблоны отчетов:**
  - Ежедневный отчет по НГДУ
  - Еженедельный сводный отчет
  - Отчет по объекту
  - Отчет по рекомендациям
- **Настройка отчета:**
  - Выбор периода
  - Выбор НГДУ/объектов
  - Выбор параметров для включения
- **Просмотр отчета:**
  - Таблицы данных
  - Графики и диаграммы
  - Выводы и рекомендации
- **Экспорт:**
  - PDF
  - Excel
  - Word

**Технологии:** React, TypeScript, Material-UI, jsPDF, xlsx

#### 1.6. Интерфейс администратора

**Назначение:** Управление системой и настройками

**Компоненты:**
- **Управление пользователями:**
  - Список пользователей
  - Роли и права доступа
  - Настройки уведомлений
- **Настройки интеграций:**
  - Настройки подключений к внешним системам
  - Расписание синхронизации данных
  - Логи синхронизации
- **Настройки алгоритмов:**
  - Параметры анализа (периоды, пороги)
  - Шаблоны рекомендаций
  - Правила классификации
- **Мониторинг системы:**
  - Статус сервисов
  - Производительность
  - Логи ошибок

**Технологии:** React, TypeScript, Material-UI

### 2. Мобильное приложение

**Назначение:** Быстрый доступ к информации и уведомлениям

**Функции:**
- Просмотр текущих тревог
- Просмотр рекомендаций
- Получение push-уведомлений
- Быстрый просмотр статистики
- Просмотр деталей объекта

**Технологии:** React Native или Flutter

### 3. REST API

**Назначение:** Интеграция с внешними системами

**Основные endpoints:**
- `GET /api/alarms` - получение списка тревог
- `GET /api/objects/{id}/analysis` - анализ объекта
- `GET /api/recommendations` - получение рекомендаций
- `POST /api/recommendations/{id}/accept` - принятие рекомендации
- `GET /api/reports` - формирование отчетов
- `GET /api/trends/{objectId}/{parameter}` - получение трендов

**Технологии:** Node.js/Express или Python/FastAPI, OpenAPI/Swagger

---

## Интеграции с внешними системами

### 1. АСДКУ (Автоматизированная система диспетчерского контроля и управления)

**Тип интеграции:** API или OPC/OPC UA

**Данные:**
- Текущие значения параметров (давление, уровень, температура)
- Состояние оборудования (работает/остановлено)
- История изменений параметров
- Список аварийных сигналов

**Частота синхронизации:** Реальное время или каждые 1-5 минут

**Технологии:** REST API, OPC UA Client, WebSocket

### 2. ИС «МЕГА»

**Тип интеграции:** API

**Данные:**
- Исторические данные параметров
- Тренды
- Метаданные объектов

**Частота синхронизации:** Ежедневно или по запросу

**Технологии:** REST API

### 3. ИС «Проток»

**Тип интеграции:** API

**Данные:**
- Исторические данные параметров
- Тренды
- Метаданные объектов

**Частота синхронизации:** Ежедневно или по запросу

**Технологии:** REST API

### 4. ЕССД (Единая система сбора данных)

**Тип интеграции:** API

**Данные:**
- Список аварийных сигналов
- Метаданные сигналов

**Частота синхронизации:** Реальное время или каждые 5-15 минут

**Технологии:** REST API, WebSocket

### 5. КИС «Армитс»

**Тип интеграции:** API

**Данные:**
- Объемы перекачки жидкости
- Прогнозы добычи
- Метаданные оборудования (марка, модель)

**Частота синхронизации:** Ежедневно

**Технологии:** REST API

### 6. 1С ТОиР

**Тип интеграции:** API или файловый обмен

**Данные:**
- Метаданные оборудования (марка, модель, паспортные данные)
- История обслуживания
- Сроки эксплуатации

**Частота синхронизации:** Ежедневно или по запросу

**Технологии:** REST API, 1C:Enterprise API, файловый обмен

### 7. СЭД (Система электронного документооборота)

**Тип интеграции:** API или файловый обмен

**Данные:**
- Перечни блокировок и сигнализаций (PDF)
- Документы согласования

**Частота синхронизации:** По запросу или при изменении документов

**Технологии:** REST API, файловый обмен, PDF парсинг

### 8. РД (Руководящие документы)

**Тип интеграции:** Файловое хранилище

**Данные:**
- Нормативные требования (PDF)
- Требования ФНиП

**Частота синхронизации:** При обновлении документов

**Технологии:** Файловое хранилище, PDF парсинг, NLP для извлечения требований

---

## Технический стек

### Backend

**Язык программирования:**
- Python 3.11+ (предпочтительно для аналитики и алгоритмов)
- Или Node.js 20+ (если требуется высокая производительность API)

**Фреймворки:**
- FastAPI (Python) - для REST API
- Или Express.js (Node.js) - для REST API
- Celery (Python) - для фоновых задач
- Или Bull (Node.js) - для фоновых задач

**Базы данных:**
- PostgreSQL 15+ - для метаданных, рекомендаций, пользователей
- TimescaleDB (расширение PostgreSQL) - для временных рядов
- Или InfluxDB - альтернатива для временных рядов
- Redis - для кэширования и очередей задач

**Обработка данных:**
- Pandas - для анализа данных
- NumPy - для численных вычислений
- SciPy - для статистического анализа

**Парсинг документов:**
- PyPDF2 или pdfplumber - для парсинга PDF
- python-docx - для работы с Word документами
- openpyxl - для работы с Excel

### Frontend

**Фреймворк:**
- React 18+
- TypeScript 5+

**UI библиотеки:**
- Material-UI (MUI) v5
- Или Ant Design
- Или Chakra UI

**Графики:**
- Chart.js с react-chartjs-2
- Или Recharts
- Или Apache ECharts

**Состояние:**
- React Query (TanStack Query) - для серверного состояния
- Zustand или Redux Toolkit - для клиентского состояния

**Формы:**
- React Hook Form
- Zod - для валидации

**Отчеты:**
- jsPDF - для генерации PDF
- xlsx - для генерации Excel
- react-pdf - для рендеринга PDF в браузере

### Мобильное приложение

**Фреймворк:**
- React Native
- Или Flutter

**Навигация:**
- React Navigation (для React Native)
- Или Navigator 2.0 (для Flutter)

### Инфраструктура

**Контейнеризация:**
- Docker
- Docker Compose

**Оркестрация (опционально):**
- Kubernetes (для продакшена)

**Веб-сервер:**
- Nginx - для reverse proxy и статики

**Мониторинг:**
- Prometheus - для метрик
- Grafana - для визуализации
- ELK Stack (Elasticsearch, Logstash, Kibana) - для логов

**CI/CD:**
- GitLab CI/CD
- Или GitHub Actions
- Или Jenkins

### Интеграции

**OPC UA:**
- asyncua (Python)
- Или node-opcua (Node.js)

**API клиенты:**
- httpx (Python)
- Или axios (Node.js)

**WebSocket:**
- websockets (Python)
- Или ws (Node.js)

---

## Процессы работы

### Процесс 1: Ежедневный автоматический анализ

**Триггер:** Планировщик задач (Cron) - ежедневно в 8:00

**Шаги:**
1. Загрузка списка аварийных сигналов за предыдущий день из ЕССД/АСДКУ
2. Группировка сигналов по НГДУ и объектам
3. Для каждого объекта с сигналами:
   - Загрузка исторических данных параметров (2 месяца)
   - Запуск Trend Analyzer
   - Запуск Threshold Validator
   - Запуск Equipment Status Checker
   - Запуск Alarm Classifier
4. Формирование рекомендаций (Recommendation Generator)
5. Сохранение результатов в базу данных
6. Отправка уведомлений адресатам (Notification Service)
7. Формирование ежедневного отчета
8. Отправка отчета руководству ЦДНГ

**Время выполнения:** 30-60 минут (в зависимости от количества объектов)

### Процесс 2: Анализ по запросу пользователя

**Триггер:** Запрос пользователя через веб-интерфейс

**Шаги:**
1. Пользователь выбирает объект и период анализа
2. Запрос отправляется на backend
3. Загрузка данных по объекту за указанный период
4. Запуск всех компонентов анализа
5. Формирование результатов
6. Возврат результатов пользователю
7. Отображение результатов в интерфейсе

**Время выполнения:** 10-30 секунд (в зависимости от объема данных)

### Процесс 3: Синхронизация данных из внешних систем

**Триггер:** Планировщик задач или события из внешних систем

**Шаги:**
1. Подключение к внешней системе (АСДКУ, Мега, Проток)
2. Загрузка новых/обновленных данных
3. Нормализация данных
4. Сохранение в базу данных
5. Обновление кэша
6. Логирование результатов синхронизации

**Частота:**
- АСДКУ: каждые 1-5 минут (реальное время)
- Мега, Проток: ежедневно
- КИС «Армитс»: ежедневно
- 1С ТОиР: ежедневно
- СЭД: по событию изменения документа

### Процесс 4: Обработка новой аварийной тревоги

**Триггер:** Поступление нового сигнала из ЕССД/АСДКУ (WebSocket или polling)

**Шаги:**
1. Получение сигнала
2. Сохранение в базу данных
3. Быстрый анализ (Equipment Status Checker) для определения ложного сигнала
4. Если ложный сигнал - пометить и уведомить
5. Если реальный сигнал - добавить в очередь для полного анализа
6. Уведомление диспетчера ЕДС

**Время выполнения:** < 5 секунд

### Процесс 5: Применение рекомендации

**Триггер:** Пользователь принимает рекомендацию в интерфейсе

**Шаги:**
1. Пользователь просматривает рекомендацию
2. Пользователь принимает рекомендацию
3. Изменение статуса рекомендации на "Принята"
4. Если рекомендация требует изменения уставок:
   - Формирование заявки для ООО «ПЦ»
   - Отправка заявки (email или интеграция с системой заявок)
5. Если рекомендация требует замены оборудования:
   - Формирование заявки для УДНГ/УСПП
   - Отправка заявки
6. Отслеживание выполнения рекомендации
7. После выполнения - повторный анализ для подтверждения

---

## Модель данных

### Основные сущности

#### 1. Object (Объект)

```sql
CREATE TABLE objects (
    id UUID PRIMARY KEY,
    name VARCHAR(255) NOT NULL,
    code VARCHAR(100) UNIQUE,
    ngdu_id UUID REFERENCES ngdu(id),
    object_type VARCHAR(50), -- 'ДНС', 'ГЗНУ', 'УПСВ', 'ГЗУ', 'БГ', 'Скважина'
    location VARCHAR(255),
    status VARCHAR(50), -- 'active', 'inactive', 'decommissioned'
    created_at TIMESTAMP,
    updated_at TIMESTAMP
);
```

#### 2. Equipment (Оборудование)

```sql
CREATE TABLE equipment (
    id UUID PRIMARY KEY,
    object_id UUID REFERENCES objects(id),
    name VARCHAR(255) NOT NULL,
    equipment_type VARCHAR(100), -- 'насос', 'емкость', 'сепаратор'
    model VARCHAR(255),
    manufacturer VARCHAR(255),
    serial_number VARCHAR(100),
    installation_date DATE,
    expiration_date DATE,
    max_pressure DECIMAL(10,2),
    min_pressure DECIMAL(10,2),
    max_flow DECIMAL(10,2),
    min_flow DECIMAL(10,2),
    status VARCHAR(50), -- 'operational', 'stopped', 'maintenance', 'decommissioned'
    created_at TIMESTAMP,
    updated_at TIMESTAMP
);
```

#### 3. Parameter (Параметр)

```sql
CREATE TABLE parameters (
    id UUID PRIMARY KEY,
    object_id UUID REFERENCES objects(id),
    equipment_id UUID REFERENCES equipment(id),
    parameter_type VARCHAR(50), -- 'pressure', 'level', 'temperature', 'flow'
    parameter_name VARCHAR(255), -- 'Давление на приеме Н-1', 'Уровень в Е-1'
    measurement_unit VARCHAR(20), -- 'МПа', 'м', '°C', 'м³/сут'
    tag_name VARCHAR(100), -- Тег в АСДКУ
    data_source VARCHAR(50), -- 'АСДКУ', 'Мега', 'Проток'
    created_at TIMESTAMP,
    updated_at TIMESTAMP
);
```

#### 4. Threshold (Уставка)

```sql
CREATE TABLE thresholds (
    id UUID PRIMARY KEY,
    parameter_id UUID REFERENCES parameters(id),
    threshold_type VARCHAR(50), -- 'min', 'max', 'alarm_min', 'alarm_max', 'warning_min', 'warning_max'
    value DECIMAL(10,4) NOT NULL,
    source VARCHAR(50), -- 'СЭД', 'manual', 'recommended'
    document_reference VARCHAR(255), -- Ссылка на документ СЭД
    effective_date DATE,
    expiration_date DATE,
    status VARCHAR(50), -- 'active', 'pending', 'expired'
    created_at TIMESTAMP,
    updated_at TIMESTAMP
);
```

#### 5. TimeSeriesData (Временные ряды)

```sql
-- Используется TimescaleDB
CREATE TABLE time_series_data (
    time TIMESTAMPTZ NOT NULL,
    parameter_id UUID NOT NULL,
    value DECIMAL(10,4),
    quality INTEGER, -- Качество данных (0-100)
    PRIMARY KEY (time, parameter_id)
);

-- Создание hypertable для TimescaleDB
SELECT create_hypertable('time_series_data', 'time');
```

#### 6. Alarm (Аварийный сигнал)

```sql
CREATE TABLE alarms (
    id UUID PRIMARY KEY,
    parameter_id UUID REFERENCES parameters(id),
    alarm_type VARCHAR(50), -- 'high', 'low', 'alarm_high', 'alarm_low'
    alarm_message TEXT,
    triggered_at TIMESTAMP NOT NULL,
    resolved_at TIMESTAMP,
    status VARCHAR(50), -- 'active', 'resolved', 'false_alarm'
    classification VARCHAR(50), -- 'real', 'false', 'unknown'
    cause TEXT,
    ngdu_id UUID REFERENCES ngdu(id),
    created_at TIMESTAMP
);

CREATE INDEX idx_alarms_triggered_at ON alarms(triggered_at);
CREATE INDEX idx_alarms_status ON alarms(status);
```

#### 7. TrendAnalysis (Анализ трендов)

```sql
CREATE TABLE trend_analyses (
    id UUID PRIMARY KEY,
    parameter_id UUID REFERENCES parameters(id),
    analysis_date DATE NOT NULL,
    period_start DATE NOT NULL,
    period_end DATE NOT NULL,
    avg_value DECIMAL(10,4),
    min_value DECIMAL(10,4),
    max_value DECIMAL(10,4),
    median_value DECIMAL(10,4),
    std_deviation DECIMAL(10,4),
    prev_period_avg DECIMAL(10,4),
    change_percent DECIMAL(5,2),
    trend VARCHAR(20), -- 'increasing', 'decreasing', 'stable'
    anomalies JSONB,
    created_at TIMESTAMP
);
```

#### 8. Recommendation (Рекомендация)

```sql
CREATE TABLE recommendations (
    id UUID PRIMARY KEY,
    object_id UUID REFERENCES objects(id),
    parameter_id UUID REFERENCES parameters(id),
    recommendation_type VARCHAR(50), -- 'change_threshold', 'replace_equipment', 'disable_alarm', 'exclude_condition', 'epb', 'develop_measures'
    title VARCHAR(255) NOT NULL,
    description TEXT NOT NULL,
    justification TEXT,
    current_value DECIMAL(10,4),
    recommended_value DECIMAL(10,4),
    priority VARCHAR(20), -- 'high', 'medium', 'low'
    status VARCHAR(50), -- 'new', 'accepted', 'in_progress', 'completed', 'rejected'
    assignee_id UUID REFERENCES users(id),
    assignee_role VARCHAR(50), -- 'ЦДНГ', 'ООО ПЦ', 'специалист отдела'
    created_at TIMESTAMP,
    updated_at TIMESTAMP,
    completed_at TIMESTAMP
);

CREATE INDEX idx_recommendations_status ON recommendations(status);
CREATE INDEX idx_recommendations_priority ON recommendations(priority);
```

#### 9. RecommendationHistory (История рекомендаций)

```sql
CREATE TABLE recommendation_history (
    id UUID PRIMARY KEY,
    recommendation_id UUID REFERENCES recommendations(id),
    action VARCHAR(50), -- 'created', 'accepted', 'rejected', 'completed', 'commented'
    user_id UUID REFERENCES users(id),
    comment TEXT,
    created_at TIMESTAMP
);
```

#### 10. NGDU (Нефтегазодобывающее управление)

```sql
CREATE TABLE ngdu (
    id UUID PRIMARY KEY,
    code VARCHAR(10) UNIQUE NOT NULL, -- 'НГДУ-1', 'НГДУ-2', etc.
    name VARCHAR(255) NOT NULL,
    created_at TIMESTAMP
);
```

#### 11. User (Пользователь)

```sql
CREATE TABLE users (
    id UUID PRIMARY KEY,
    username VARCHAR(100) UNIQUE NOT NULL,
    email VARCHAR(255) UNIQUE NOT NULL,
    full_name VARCHAR(255),
    role VARCHAR(50), -- 'dispatcher', 'master', 'manager', 'specialist', 'admin'
    ngdu_id UUID REFERENCES ngdu(id),
    notification_preferences JSONB,
    created_at TIMESTAMP,
    updated_at TIMESTAMP
);
```

### Связи между сущностями

```
NGDU (1) ──< (N) Objects
Object (1) ──< (N) Equipment
Object (1) ──< (N) Parameters
Equipment (1) ──< (N) Parameters
Parameter (1) ──< (N) Thresholds
Parameter (1) ──< (N) TimeSeriesData
Parameter (1) ──< (N) Alarms
Parameter (1) ──< (N) TrendAnalyses
Object (1) ──< (N) Recommendations
Parameter (1) ──< (N) Recommendations
Recommendation (1) ──< (N) RecommendationHistory
```

---

## Заключение

Данный документ описывает архитектуру и компоненты алгоритмической системы анализа аварийных сигналов для первого этапа проекта. Система обеспечивает:

1. **Автоматический анализ** трендов и параметров оборудования
2. **Проверку соответствия** уставок фактическим параметрам
3. **Выявление ложных сигналов** и несоответствий
4. **Генерацию рекомендаций** по устранению проблем
5. **Удобные интерфейсы** для различных ролей пользователей
6. **Интеграцию** с существующими системами предприятия

Система построена на детерминированных алгоритмах без использования машинного обучения, что обеспечивает прозрачность и предсказуемость результатов.

---

**Следующие шаги:**
1. Детализация алгоритмов анализа
2. Проектирование API
3. Проектирование интерфейсов (wireframes, mockups)
4. Планирование развертывания
5. Планирование тестирования

